# Лекция №5. Работа с данными в формате JSON

## 1. Введение в JSON

> **JSON (JavaScript Object Notation)** — текстовый формат обмена данными, основанный на синтаксисе JavaScript, но независимый от него; поддерживается всеми современными языками программирования.

**Автор:** Дуглас Крокфорд.

**Преимущества:**  
- Лаконичность (компактнее XML)  
- Читаемость человеком  
- Лёгкость обработки на любом языке  
- Широкое применение в веб-разработке (AJAX, REST API, конфигурационные файлы)

---

## 2. Синтаксис JSON

JSON-текст представляет собой одну из двух структур:

| Структура | Описание | Синтаксис |
|-----------|----------|-----------|
| **Объект** | Неупорядоченное множество пар `ключ: значение` | `{ }` |
| **Массив** | Упорядоченное множество значений | `[ ]` |

**Допустимые типы значений:**  
- Строка (в двойных кавычках)  
- Число  
- Объект  
- Массив  
- Логические значения: `true`, `false`  
- Пустое значение: `null`

> **Важно:** Вложенность структур не ограничена.

---

## 3. JSON-объект

> **JSON-объект** — неупорядоченное множество пар «ключ: значение», заключённое в фигурные скобки `{ }`.

**Пример:**
```json
{
  "firstName": "Иван",
  "lastName": "Иванов",
  "address": {
    "streetAddress": "Московское ш., 101, кв.101",
    "city": "Ленинград",
    "postalCode": 101101
  },
  "phoneNumbers": [
    "812 123-1234",
    "916 123-4567"
  ]
}
```

### Правила объявления JSON-объектов

| Допустимо | Недопустимо |
|-------------|---------------|
| `{ "name": "Иван" }` | `{ name: "Иван" }` (ключ без кавычек) |
| `{ "count": 7 }` | `{ "count": 7, }` (лишняя запятая) |
| `{ "items": [1, 2, 3] }` | `{ "items": [1, 2, 3], }` |
| `{ "obj": { "x": 1 } }` | `{ x: 1 }` как значение без ключа |

**Ключевые правила:**  
1. **Ключ — всегда строка**, обязательно в двойных кавычках.  
2. **Строки** — только в двойных кавычках.  
3. **Числа, true, false, null** — без кавычек.  
4. **Запятые** ставятся между парами, после последней пары запятая **не ставится**.  
5. **Порядок ключей** не имеет значения.  
6. **Пробелы и переносы** — только для читаемости, не обязательны.

---

## 4. JSON-массив

> **JSON-массив** — упорядоченное множество значений, заключённое в квадратные скобки `[ ]`.

**Примеры:**
```json
[ "MALE", "FEMALE" ]
[ 1, 5, 10, 33 ]
[ 1, "Андрей", true, null ]
[ { "name": "Иван" }, { "name": "Пётр" } ]
```

**Особенности:**  
- Доступ к элементам — по индексу (порядок значим).  
- Массив может содержать значения любого типа, включая объекты и другие массивы.  
- Уровень вложенности не ограничен.

---

## 5. Краткая шпаргалка по JSON

| Синтаксис | Значение | Пример |
|-----------|---------|--------|
| `{ }` | Объект | `{ "key": "value" }` |
| `[ ]` | Массив | `[ 1, 2, 3 ]` |
| `"строка"` | Строка | `"Hello"` |
| `123` | Число | `42`, `3.14` |
| `true` / `false` | Булево | `true` |
| `null` | Пусто | `null` |

> **Запомнить:**  
> - Объект = **ключи в кавычках** + значения  
> - Массив = **только значения** (без ключей)  
> - Ключи всегда в **двойных кавычках**  
> - После последнего элемента **нет запятой**

---

## 6. Работа с JSON в C#

> **`System.Text.Json`** — стандартное пространство имён в .NET для работы с JSON; основной класс — `JsonSerializer`.

### 6.1. Базовая сериализация и десериализация

```csharp
using System.Text.Json;

Person tom = new Person("Tom", 37);
string json = JsonSerializer.Serialize(tom);
Console.WriteLine(json);

Person? restoredPerson = JsonSerializer.Deserialize<Person>(json);
Console.WriteLine(restoredPerson?.Name); // Tom

class Person
{
    public string Name { get; }
    public int Age { get; set; }

    public Person(string name, int age)
    {
        Name = name;
        Age = age;
    }
}
```

> **Что происходит:**  
> - `Serialize()` — преобразует объект в JSON-строку.  
> - `Deserialize<T>()` — восстанавливает объект из JSON.

> **Требования:**  
> - Для десериализации нужен **конструктор без параметров** или конструктор, параметры которого соответствуют именам свойств в JSON.  
> - Сериализуются **только публичные свойства** (`public`).

---

### 6.2. Работа с файлами

```csharp
using System.Text.Json;

// Сохранение в файл
using (FileStream fs = new FileStream("user.json", FileMode.OpenOrCreate))
{
    Person tom = new Person("Tom", 37);
    await JsonSerializer.SerializeAsync<Person>(fs, tom);
    Console.WriteLine("Data saved to file");
}

// Чтение из файла
using (FileStream fs = new FileStream("user.json", FileMode.OpenOrCreate))
{
    Person? person = await JsonSerializer.DeserializeAsync<Person>(fs);
    Console.WriteLine($"Name: {person?.Name} Age: {person?.Age}");
}
```

> **Особенности:**  
> - `SerializeAsync()` и `DeserializeAsync()` — асинхронные методы для работы с потоками.  
> - Используется `FileStream` для прямого доступа к файлу.

---

### 6.3. Настройка сериализации через атрибуты

```csharp
using System.Text.Json;
using System.Text.Json.Serialization;

Person roman = new Person("Roman", 25);
string json = JsonSerializer.Serialize<Person>(roman);
Console.WriteLine(json);

Person? person = JsonSerializer.Deserialize<Person>(json);
Console.WriteLine($"Name: {person?.Name} Age: {person?.Age}");

class Person
{
    [JsonPropertyName("firstname")]
    public string Name { get; }

    [JsonIgnore]
    public int Age { get; set; }

    public Person(string name, int age)
    {
        Name = name;
        Age = age;
    }
}
```

> **Атрибуты управления сериализацией:**

| Атрибут | Назначение | Пример |
|---------|-----------|--------|
| `[JsonPropertyName("имя")]` | Задаёт другое имя свойства в JSON | `"firstname"` вместо `"Name"` |
| `[JsonIgnore]` | Исключает свойство из сериализации | Свойство `Age` не попадает в JSON |

> **Результат выполнения:**  
> ```json
> {"firstname":"Roman"}
> ```  
> Свойство `Age` отсутствует в JSON, при десериализации получает значение по умолчанию (`0`).

---

### 6.4. Сводная таблица операций

| Операция | Метод | Особенности |
|----------|-------|-------------|
| **Сериализация** | `Serialize()` / `SerializeAsync()` | Объект → JSON (строка/поток) |
| **Десериализация** | `Deserialize<T>()` / `DeserializeAsync<T>()` | JSON → Объект |
| **Исключение свойства** | `[JsonIgnore]` | Свойство игнорируется |
| **Переименование свойства** | `[JsonPropertyName("...")]` | Задаёт другое имя в JSON |

---

> **Итог:** JSON — стандартный формат обмена данными, простой для чтения и написания, легко преобразуемый в объекты практически любого языка программирования. В .NET работа с JSON осуществляется через `System.Text.Json`, который поддерживает гибкую настройку сериализации и асинхронную работу с файлами.

--- 